version: "2.1"
description: "Simulate 'Only build pull requests' with git-flow"

orbs:
  only-build-pr-with-git-flow:
    jobs:
      check_enable_to_build:
        executor: simple_executor
        parameters:
          build_branches:
            description: "permit branches to build without pull requests. separate spaces"
            default: "master develop"
            type: string
        steps:
          - my_inline_command:
              build_branches: <<parameters.build_branches>>
    commands:
      my_inline_command:
        parameters:
          build_branches:
            type: string
        steps:
          - run:
            shell: /bin/bash
            command: |
              echo << parameters.build_branches >>

              if [ $CIRCLE_BRANCH = "develop" -o $CIRCLE_BRANCH = "master" ]; then
                exit 0
              elif [ -n "$CIRCLE_PULL_REQUEST" ]; then
                exit 0
              else
                echo "If a pull request has not been created, CI will not be executed"
                exit 1
              fi

    executors:
      simple_executor:
        parameters:
          version:
            type: string
            default: "2.4"
        docker:
          - image: circleci/ruby:<<parameters.version>>

workflows:
  only-build-pr-with-git-flow:
    jobs:
      - only-build-pr-with-git-flow:check_enable_to_build